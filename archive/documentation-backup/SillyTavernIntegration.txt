
Int√©gration de SillyTavern dans votre Cluster AutoWeave (Kind)

Ce guide est votre feuille de route, ClaudeCode. Suivez-le pour int√©grer SillyTavern, l'interface conversationnelle, dans votre cluster Kind. Chaque √©tape est pens√©e pour la clart√© et la tra√ßabilit√©.

Objectifs Cl√©s

    D√©ployer SillyTavern dans le cluster Kubernetes autoweave.

    Assurer l'acc√®s √† son interface web.

    Pr√©parer l'int√©gration avec votre API AutoWeave.

    Enregistrer chaque action via le DevLogger.milestone pour un suivi pr√©cis.

    Mettre √† jour le fichier docs/development-progress.md en temps r√©el.

    G√©n√©rer un handoff-summary.md en fin de session.

Pr√©requis : V√©rifications Essentielles

ClaudeCode, lancez ces v√©rifications. Logguez les r√©sultats pour chaque point.

    Cluster Kind autoweave : Assurez-vous qu'il est accessible.
    Bash

kubectl cluster-info --context kind-autoweave
# DevLogger: logger.milestone('Phase1', 'Kubernetes cluster check for SillyTavern', 'completed', { clusterName: 'autoweave', status: 'accessible' });

Outils CLI : Confirmez la pr√©sence de kubectl, helm, et git.
Bash

kubectl version --client --short && helm version --short && git --version
# DevLogger: logger.milestone('Phase1', 'Essential CLI tools check (kubectl, helm, git)', 'completed');

API AutoWeave : V√©rifiez qu'elle est pr√™te pour les futures connexions.
Bash

    # (Lancez-la si n√©cessaire apr√®s le d√©ploiement de SillyTavern)
    # DevLogger: logger.milestone('Phase2', 'AutoWeave API availability for SillyTavern', 'started', { action: 'manual check after deployment' });

Phase 1 : D√©ploiement de SillyTavern sur Kubernetes

SillyTavern est une application Node.js. Nous allons la conteneuriser et la d√©ployer avec des manifestes Kubernetes.

1. Cr√©er le Dockerfile pour SillyTavern

Dans autoweave/docker/, cr√©ez Dockerfile.sillytavern. Ce fichier permet de construire l'image Docker de SillyTavern.
Dockerfile

# autoweave/docker/Dockerfile.sillytavern
FROM node:20-alpine AS builder

RUN npm install -g pnpm
WORKDIR /app
COPY . .
RUN pnpm install --prod --frozen-lockfile

FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app .
EXPOSE 80
CMD ["node", "server.js"]

Bash

# DevLogger: logger.milestone('Phase1', 'SillyTavern Dockerfile creation', 'completed', { filePath: 'autoweave/docker/Dockerfile.sillytavern' });

2. Cloner SillyTavern et Construire l'Image Docker

Clonez temporairement le d√©p√¥t SillyTavern, construisez l'image Docker avec le Dockerfile que vous venez de cr√©er, et chargez-la dans votre cluster Kind.
Bash

START_TIME=$(date +%s)
cd /tmp
git clone https://github.com/SillyTavern/SillyTavern.git
cd SillyTavern

# Assurez-vous que le chemin vers le Dockerfile est correct.
docker build -f /home/gontrand/autoweave/docker/Dockerfile.sillytavern -t sillytavern-autoweave:latest .
kind load docker-image sillytavern-autoweave:latest --name autoweave

cd /home/gontrand/autoweave
rm -rf /tmp/SillyTavern
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# DevLogger: logger.milestone('Phase1', 'SillyTavern image build and load to Kind', 'completed', {
#     imageName: 'sillytavern-autoweave:latest',
#     durationSeconds: DURATION,
#     details: 'Cloned SillyTavern, built Docker image, loaded into Kind cluster.'
# });

Important pour ClaudeCode : Assurez-vous que Docker tourne bien sur votre machine h√¥te.

3. Cr√©er les Manifestes Kubernetes

Cr√©ez sillytavern-manifests.yaml dans autoweave/config/k8s/. Ce fichier d√©finit comment SillyTavern sera d√©ploy√© dans votre cluster.
YAML

# autoweave/config/k8s/sillytavern-manifests.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: sillytavern
  namespace: autoweave-system
  labels:
    app: sillytavern
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sillytavern
  template:
    metadata:
      labels:
        app: sillytavern
    spec:
      containers:
      - name: sillytavern
        image: sillytavern-autoweave:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
        env:
        - name: NODE_ENV
          value: production
---
apiVersion: v1
kind: Service
metadata:
  name: sillytavern-service
  namespace: autoweave-system
  labels:
    app: sillytavern
spec:
  selector:
    app: sillytavern
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP

Bash

# DevLogger: logger.milestone('Phase1', 'SillyTavern Kubernetes manifests creation', 'completed', {
#     filePath: 'autoweave/config/k8s/sillytavern-manifests.yaml',
#     components: ['Deployment', 'Service'],
#     persistencyConfigured: 'no_for_initial_test'
# });

Note pour ClaudeCode : Pour l'instant, la persistance n'est pas configur√©e. Si vous avez besoin de sauvegarder les donn√©es de SillyTavern (personnages, chats), vous devrez ajouter des PersistentVolumeClaims et PersistentVolumes. C'est une √©tape d'am√©lioration future.

4. D√©ployer SillyTavern avec kubectl

Appliquez les manifestes pour d√©ployer SillyTavern dans le namespace autoweave-system.
Bash

START_TIME=$(date +%s)
kubectl apply -f autoweave/config/k8s/sillytavern-manifests.yaml
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# DevLogger: logger.milestone('Phase1', 'SillyTavern Kubernetes deployment initiation', 'completed', {
#     namespace: 'autoweave-system',
#     durationSeconds: DURATION,
#     command: "kubectl apply -f autoweave/config/k8s/sillytavern-manifests.yaml"
# });

5. V√©rifier le Statut du D√©ploiement

Surveillez les pods pour confirmer que SillyTavern est bien op√©rationnel.
Bash

START_TIME=$(date +%s)
kubectl get pods -n autoweave-system -l app=sillytavern -w
# Attendez que le pod soit Running et Ready, puis utilisez CTRL+C.
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# DevLogger:
# Si le pod est Running/Ready: logger.milestone('Phase1', 'SillyTavern pod readiness check', 'completed', { status: 'pod ready', namespace: 'autoweave-system', durationSeconds: DURATION });
# Sinon: logger.milestone('Phase1', 'SillyTavern pod readiness check', 'failed', { status: 'pod not ready', namespace: 'autoweave-system', hint: 'Check SillyTavern pod logs: kubectl logs -n autoweave-system -l app=sillytavern' });

Phase 2 : Acc√©der √† l'Interface Web de SillyTavern

Nous allons utiliser un port-forward pour acc√©der √† l'interface de SillyTavern depuis votre machine locale.

1. Effectuer un Port-Forward

D√©marrez un tunnel vers le service SillyTavern. Nous utiliserons le port local 8081 pour √©viter les conflits avec Appsmith ou kagent UI.
Bash

START_TIME=$(date +%s)
SERVICE_NAME_ST=$(kubectl get svc -n autoweave-system -l app=sillytavern -o jsonpath='{.items[0].metadata.name}')

pkill -f "kubectl port-forward -n autoweave-system svc/$SERVICE_NAME_ST 8081:80" || true

kubectl port-forward -n autoweave-system svc/$SERVICE_NAME_ST 8081:80 > /dev/null 2>&1 &
PORT_FORWARD_PID_ST=$!
echo $PORT_FORWARD_PID_ST > /tmp/sillytavern-portforward.pid

sleep 5

if ps -p $PORT_FORWARD_PID_ST > /dev/null; then
    ACCESSIBLE_URL_ST="http://localhost:8081"
    STATUS_ST="completed"
else
    ACCESSIBLE_URL_ST="N/A"
    STATUS_ST="failed"
fi
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# DevLogger: logger.milestone('Phase2', 'SillyTavern UI port-forward setup', STATUS_ST, {
#     service: SERVICE_NAME_ST, localPort: 8081, remotePort: 80, pid: PORT_FORWARD_PID_ST,
#     accessibleURL: ACCESSIBLE_URL_ST, durationSeconds: DURATION, hint: 'Use kill $(cat /tmp/sillytavern-portforward.pid) to stop'
# });

2. Acc√©der et Explorer l'Interface

Ouvrez votre navigateur web et acc√©dez √† http://localhost:8081. Prenez le temps d'explorer les r√©glages, les options de connexion API, et le syst√®me d'extensions.
Bash

# DevLogger: logger.milestone('Phase2', 'SillyTavern UI initial access and exploration', 'completed', {
#     accessURL: 'http://localhost:8081',
#     task: 'Manual UI exploration, understand settings and extensions'
# });

Phase 3 : Bases d'Int√©gration avec l'API AutoWeave

Cette phase est cruciale pour que SillyTavern puisse interagir avec vos agents AutoWeave.

1. Configurer SillyTavern pour Utiliser votre LLM Orchestr√© par AutoWeave

Dans l'interface de SillyTavern, naviguez vers les R√©glages (Settings) puis API Connections.

    Type de Proxy : Choisissez "OpenAI" ou un type similaire qui correspond √† l'API de votre LLM.

    URL d'API : C'est ici que vous ferez le lien vers votre API AutoWeave. L'id√©e est que SillyTavern envoie ses requ√™tes de chat √† un endpoint que votre API AutoWeave exposera, et AutoWeave se chargera de la communication r√©elle avec le LLM via votre AgentWeaver.

        Utilisez l'IP du Gateway Docker Kind pour atteindre votre API AutoWeave locale (http://<IP_DU_GATEWAY_DOCKER_KIND>:3000).

        Vous devrez cr√©er un nouvel endpoint dans votre API AutoWeave (ex: /api/chat) qui re√ßoit la requ√™te de SillyTavern, la traite avec votre AgentWeaver, et renvoie la r√©ponse.

        Exemple d'URL : http://<votre_docker_gateway_ip>:3000/api/chat (o√π /api/chat est un endpoint que vous impl√©menterez).

Bash

# DevLogger: logger.milestone('Phase3', 'SillyTavern LLM API connection setup', 'completed', {
#     llmProxyType: 'OpenAI',
#     apiEndpoint: '<URL configur√©e pour votre API AutoWeave>',
#     details: 'Configured SillyTavern to use AutoWeave API as LLM proxy.'
# });

2. D√©finir des Outils SillyTavern pour Appeler l'API AutoWeave

SillyTavern permet d'ajouter des outils personnalis√©s via des extensions JavaScript. Ces outils seront les ponts entre l'interface conversationnelle et votre backend AutoWeave.

    Cr√©er un Fichier d'Extension : Acc√©dez au r√©pertoire de SillyTavern dans le pod (kubectl exec -it <sillytavern-pod-name> -n autoweave-system -- bash) ou mettez √† jour votre image Docker. Cr√©ez un fichier JS sous public/extensions/ (ex: autoweave-tools.js).

    Logique d'Appel API : Dans ce fichier, √©crivez des fonctions JavaScript qui utilisent fetch pour appeler les endpoints de votre API AutoWeave (ex: /api/agents pour cr√©er un agent).
    JavaScript

    // Dans SillyTavern/public/extensions/autoweave-tools.js (exemple simple)
    async function createAutoWeaveAgent(description) {
        const autoweaveApiUrl = 'http://<IP_DU_GATEWAY_DOCKER_KIND>:3000/api/agents';
        try {
            const response = await fetch(autoweaveApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ description: description })
            });
            const data = await response.json();
            if (response.ok) {
                return `Agent "${data.workflow.name}" (ID: ${data.workflow.id}) cr√©√©. Statut: ${data.deployment.status}.`;
            } else {
                return `Erreur: ${data.error || response.statusText}`;
            }
        } catch (error) {
            return `Erreur r√©seau: ${error.message}`;
        }
    }

    // Exportez la fonction pour qu'elle soit visible par SillyTavern
    // Le m√©canisme exact d√©pend des versions et des pratiques de SillyTavern
    // Vous devrez peut-√™tre la lier √† un bouton ou √† une commande / dans l'UI.

    Activer l'Extension : Dans l'interface de SillyTavern, activez votre nouvelle extension dans les r√©glages.

    Instruire l'Agent LLM : Configurez les "r√®gles" ou le "persona" de l'agent LLM dans SillyTavern pour qu'il sache qu'il dispose de l'outil createAutoWeaveAgent et quand l'utiliser en r√©ponse aux requ√™tes utilisateur (ex: "Cr√©e un agent qui surveille la temp√©rature du serveur").

Bash

# DevLogger: logger.milestone('Phase3', 'SillyTavern custom tool development for AutoWeave API', 'started', {
#     toolName: 'createAutoWeaveAgent',
#     targetAPI: 'AutoWeave /api/agents',
#     filePath: 'SillyTavern/public/extensions/autoweave-tools.js'
# });

Points de Contr√¥le Obligatoires pour ClaudeCode (Synth√®se)

ClaudeCode, assurez-vous que les logs suivants sont bien dans votre development-progress.md pour cette session :

    Phase 1 (D√©ploiement) : Logs de toutes les √©tapes de v√©rification des pr√©requis, cr√©ation du Dockerfile, build/load de l'image, cr√©ation des manifestes Kubernetes, et d√©ploiement/readiness du pod SillyTavern.

    Phase 2 (Acc√®s UI) : Logs du port-forward et de l'exploration initiale de l'interface SillyTavern.

    Phase 3 (Int√©gration API) : Logs de la configuration de la connexion LLM dans SillyTavern (pointant vers AutoWeave API) et le d√©marrage du d√©veloppement de l'outil personnalis√© createAutoWeaveAgent.

Fin de Session pour ClaudeCode

ClaudeCode, cr√©ez ou mettez √† jour le handoff-summary.md dans le r√©pertoire principal (/home/gontrand/autoweave/).

Le contenu doit inclure :

    T√¢ches Termin√©es (‚úÖ Completed Tasks) : Listez les succ√®s, comme le d√©ploiement de SillyTavern, l'acc√®s UI, et le d√©but de l'int√©gration API.

    Travaux en Cours (üöß In Progress) : D√©crivez l'√©tat de l'int√©gration de l'outil createAutoWeaveAgent et l'endpoint /api/chat dans AutoWeave.

    Prochaines √âtapes (üìã Next Instance TODO) : Mettez l'accent sur la finalisation de l'int√©gration des outils, le d√©veloppement de votre Agent de Commande dans AutoWeave, et le test de bout en bout de la cr√©ation d'agent depuis SillyTavern.

    Fichiers Modifi√©s (üìÅ Modified Files) : Listez tous les fichiers pertinents, y compris le Dockerfile, les manifestes Kubernetes, et les fichiers d'extension SillyTavern.

    Probl√®mes Connus (‚ö†Ô∏è Known Issues) : Notez toute difficult√© rencontr√©e, comme les adresses IP du Gateway Docker ou la persistance.

    √âtat de l'Environnement (üîß Environment Status) : R√©sumez l'√©tat des composants (Kind, kagent, Appsmith, SillyTavern, AutoWeave API).

    Le√ßons Apprises (üí° Lessons Learned) : Partagez les observations sur l'efficacit√© de la d√©marche ou les d√©couvertes.
